name: Terraform Destroy

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: "Digite YES para confirmar a destruição dos recursos"
        required: true
        default: "NO"

jobs:
  destroy:
    name: Destruir Infraestrutura AWS com Segurança
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Verificar branch atual
        run: |
          echo "Branch atual: ${{ github.ref_name }}"
          if [ "${{ github.ref_name }}" != "main" ]; then
            echo "Este workflow só pode ser executado no branch 'main'."
            exit 1
          fi

      - name: Validar confirmação manual
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "YES" ]; then
            echo "Confirmação inválida. Digite 'YES' para continuar."
            exit 1
          fi
          echo "Confirmação recebida. Prosseguindo com a destruição..."

      - name: Configurar credenciais AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Instalar Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5

      - name: Verificar existência do backend remoto
        run: |
          BUCKET_NAME="terraform-state-paulo-20251108"
          KEY_PATH="ec2/terraform.tfstate"

          echo "Verificando backend remoto s3://$BUCKET_NAME/$KEY_PATH ..."
          if ! aws s3api head-object --bucket "$BUCKET_NAME" --key "$KEY_PATH" >/dev/null 2>&1; then
            echo "O arquivo de state remoto não foi encontrado!"
            echo "Verifique se o backend está configurado corretamente antes de destruir."
            exit 1
          fi
          echo "Backend remoto encontrado. Prosseguindo com o destroy..."

      - name: Inicializar Terraform com backend S3
        run: |
          terraform init \
            -backend-config="bucket=terraform-state-paulo-20251108" \
            -backend-config="key=ec2/terraform.tfstate" \
            -backend-config="region=us-east-1" \
            -backend-config="encrypt=true"

      - name: Mostrar estado atual
        run: terraform state list || echo "Nenhum recurso encontrado no state."

      - name: Gerar plano de destruição
        run: terraform plan -destroy -out=tfplan -no-color

      - name: Aplicar destruição dos recursos
        run: terraform destroy -auto-approve -no-color

      - name: Confirmar atualização do backend remoto
        run: |
          echo "Verificando se o state foi atualizado no bucket..."
          aws s3 ls s3://terraform-state-paulo-20251108/ec2/ || true
          echo "Processo de destruição finalizado com sucesso."
